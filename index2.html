<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MTU GRF DEM Download Tool</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/dark/main.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">      
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">      
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>     
     <script src="https://unpkg.com/@esri/arcgis-rest-request@4.0.0/dist/bundled/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-feature-service@4.0.0/dist/bundled/feature-service.umd.js"></script> 
      <script src="https://js.arcgis.com/calcite-components/1.0.0-beta.95/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.0.0-beta.95/calcite.css" />
    <script src="https://js.arcgis.com/4.24/"></script>
    
  </head>
  <style>
    html,
    body,
#viewDiv {   
  padding: 0;
  margin: 0;
  height: 100%;
  width: 100%;      
}

body {
display: flex;
--calcite-ui-brand: #003366;
}

calcite-loader {
  z-index: 9999999 !important;  
  --calcite-ui-brand: #003366; 

}

#info-content {
  padding: 0.75rem;
}

calcite-rating {
  margin-top: 0.25rem;
}

.custom-header {
  display: flex;
  padding: 0 1rem;
  background-color: var(--calcite-ui-foreground-1);
  margin: 5px;
}

.custom-header-controls {
  margin-inline-start: auto;
  display: flex;
  align-self: center;
}

.custom-label-wrapper {
  display: flex;
  border: 1px solid var(--calcite-ui-border-1);
  margin-inline-start: 1rem;
  padding: 0 0.5rem;
}

.header-switch {
  margin: 0 0.5rem;
}
  </style>

  <body>
    <calcite-loader scale="l" label="Processing raster..."></calcite-loader>
    <div class="calcite-theme-dark">
    
    <calcite-shell content-behind hidden>
     <div slot="header" class="custom-header">
      <img src="husky.svg" width="50" height="50" class="d-inline-block align-top" alt=""><h2 id="header-title" slot="header">
        <!-- Dynamically populated -->
      </h2>
     </div>
      <calcite-shell-panel slot="primary-panel" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="measure" icon="measure-area" text="Measure"></calcite-action>
          <calcite-action data-action-id="feature" icon="popup" text="Feature"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>

        <!-- Map-specific panels (each one provides a div for a ArcGIS JavaScript API widget) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>
        <calcite-panel heading="Measurement" height-scale="l" data-panel-id="measure" hidden>
          <div id="measure-container"></div>
        </calcite-panel>
        <calcite-panel heading="Feature" height-scale="l" data-panel-id="feature" hidden>
          <div id="feature-container"></div>
        </calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Details" data-panel-id="information" hidden>
          <div id="info-content">
           <calcite-label layout="inline">About</calcite-label>
              <p>This application serves as an Index map allowing for the discovery and download of Two-Foot Resolution Digital Elevation Model (DEM) tiles for Houghton and Keweenaw Counties. The DEM coverage is available as mosaics of individual townships. To download a DEM click on the Township and Range section on the PLSS you of the township you are interested in downloading the DEM for and click 'Download' under the Township and Range title or  ‘View’ next to the Download DEM section of the pop-up in the sidebar. The link will direct you to our Google Drive account where you can download the high-resolution DEM.</p>

              <calcite-label layout="inline">Metadata</calcite-label>
              <p>Originator: Quantum Spatial, Inc.<br>
              Date Created: 2018<br>
              Lidar Scan Angle: 18<br>
              Altitude Datum: NAVD88<br>
              Lidar Normal Point Spacing: 0.6m<br>
              Lidar Specification: USGS-NGP Base Specification (2011) State Plane Michigan North FIPS 2011, intl feet<br>
              Lidar CRS: NAD83 (2011) State Plane Michigan North FIPS 2111, Intl feet<br>
              Lidar Sensor: Leica ALS70<br>
              Place: Ottawa National Forest<br>
              Created by: Steven Anderson<br>
              State Name: Michigan<br>
              Distributing Agency: Sanborn Map Company, Inc.<br> 
              Area of Interest: Houghton<br>
              Year Published: 2020</p>            
          </div>
        </calcite-panel>
      </calcite-shell-panel>
      <div id="viewDiv"></div>
    </calcite-shell>
  </div>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/widgets/Print",
      "esri/config", 
      "esri/WebMap", 
      "esri/layers/TileLayer",
      "esri/layers/GraphicsLayer",      
      "esri/widgets/Expand", 
      "esri/widgets/Sketch", 
      "esri/widgets/Measurement",
      "esri/geometry/projection",
      "esri/geometry/SpatialReference", 
      "esri/geometry/Extent",
      "esri/widgets/Feature",
      "esri/widgets/ScaleBar"
    ], function(WebMap, MapView, Bookmarks, BasemapGallery, LayerList, Legend, Print, esriConfig, WebMap, TileLayer, GraphicsLayer, Expand, Sketch, Measurement, projection, SpatialReference, Extent, Feature, ScaleBar) {
      // create a new graphics layer for the sketch
      const graphicsLayer = new GraphicsLayer();
      // Set the portal URL
      esriConfig.portalUrl = "https://portal1-geo.sabu.mtu.edu/mtuarcgis/";
      const webmap = new WebMap({
        portalItem: { // autocasts as new PortalItem()
          id: "7a28167c146147d1a71ecb74f13ed636"
        }
      });

      const view = new MapView({
        container: "viewDiv", // Reference to the view div created in step 5
        map: webmap, // Reference to the map object created before the view          
        popup:{
          highlightEnabled: true,
          dockEnabled: false,
          dockOptions: {
              buttonEnabled: false,
              breakpoint: false,
              position:"top-center"
          }
        }
      });  

      view.padding.left = 45;

      webmap.add(graphicsLayer);       
      
      view.ui.move("zoom", "top-left");

      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });      

      const layerList = new LayerList({
        view,
        selectionEnabled: true,
        container: "layers-container"
      });

      const legend = new Legend({
        view,
        container: "legend-container"
      });
/*
      const feature = new Feature({
        //view,
        map: webmap,
        spatialReference: view.SpatialReference,
        container: "feature-container"
      });*/

      const scaleBar = new ScaleBar({
        view: view
      });
      // Add widget to the bottom left corner of the view
      view.ui.add(scaleBar, {
        position: "bottom-left"
      });

      const sketch = new Sketch({
        layer: graphicsLayer,
        view: view,
        // graphic will be selected as soon as it is created
        creationMode: "update",
      //  container: "bookmarks-container"              
      });      

      // Setting the sketch's visible elements as below would result
      // in removing the point and circle tools. It also removes the
      // lasso-selection tool and settings menu.
      sketch.visibleElements = {
        createTools: {
          point: false,
          circle: false,
          polyline: false,
          polygon: false
        },
        selectionTools:{
          "lasso-selection": false,
          "rectangle-selection": false
        },
        settingsMenu: true
      }

      view.ui.add(sketch, "top-right");

      // Listen to sketch widget's create event.
      sketch.on("create", function(event) {                 
        // check if the create event's state has changed to complete indicating
        // the graphic create operation is completed.
        if (event.state === "complete") {
          document.querySelector("calcite-loader").active = true;
          // get the extent of the drawn feature                               
         // pixelsize X and Y from the image service
         var resolution = (1.738696247684391 + 1.7386962476843981) / 2;

         // get the width and height from the bounding box
         var width = (event.graphic.geometry.extent.xmax - event.graphic.geometry.extent.xmin);
         var height = (event.graphic.geometry.extent.ymax - event.graphic.geometry.extent.ymin);

         var ps = 0.25;

         var size = (parseInt(width / ps)).toString() + ", " + (parseInt(height / ps)).toString();       
         console.log(size);  
          $.ajax({
            dataType: 'json',
            url: 'https://gis-core.sabu.mtu.edu:6443/arcgis/rest/services/wupdem/ImageServer/exportImage?bbox=' + event.graphic.geometry.extent.xmin +  '%2C'+ event.graphic.geometry.extent.ymin + '%2C' + event.graphic.geometry.extent.xmax + '%2C' + event.graphic.geometry.extent.ymax + '&bboxSR=3857&size=' + size + '&imageSR=&time=&format=tiff&pixelType=F32&noData=0&noDataInterpretation=esriNoDataMatchAny&interpolation=+RSP_BilinearInterpolation&compression=&compressionQuality=&bandIds=&sliceId=&mosaicRule=&renderingRule=&adjustAspectRatio=true&validateExtent=false&lercVersion=1&compressionTolerance=&f=json',               
            success: function(data) { 
              document.querySelector("calcite-loader").active = false;  
              console.log(data);
              // Get the .TIF url and download the image
              const a = document.createElement("a");
              a.href = data.href;
              a.download = "";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);        
            }
          });
        };   
      });

      view.on("click", (event) => {
        view.popup.fetchFeatures(event).then((response) => {
            console.log(response);
          response.promisesPerLayerView.forEach((fetchResult) => {
            const layerView = fetchResult.layerView;
            // Iterate through the promise results to access its graphics
            fetchResult.promise.then((graphics) => {
              console.log(graphics);

      const feature = new Feature({
        graphic: graphics,
        map: webmap,
        spatialReference: view.SpatialReference,
        container: "feature-container"
      });
            });
          });   
        });

      });  

      webmap.when(() => {
        const { title, description, thumbnailUrl, avgRating } = webmap.portalItem;
        document.querySelector("#header-title").textContent = "MTU GRF DEM Download Tool";
       // document.querySelector("#item-description").innerHTML = description;
        //document.querySelector("#item-thumbnail").src = thumbnailUrl;
       // document.querySelector("#item-rating").value = avgRating;

        let activeWidget;

        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);

        let actionBarExpanded = false;

        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });

        document.querySelector("calcite-shell").hidden = false;
       // document.querySelector("calcite-loader").active = false;

      });
    });
  </script>
</html>